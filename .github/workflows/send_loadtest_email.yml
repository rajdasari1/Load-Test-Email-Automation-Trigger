name: Build and Send Load Test Email

on:
  workflow_dispatch: {}   # Ensures it appears in Actions tab for manual runs
  push:
    paths:
      - "data/*.csv"
      - "src/**"
      - "requirements.txt"
      - ".github/workflows/send_loadtest_email.yml"
  schedule:
    - cron: "0 23 * * 1-5"

jobs:
  build-and-send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build email HTML from CSVs
        env:
          DATA_DIR: data
          TEMPLATE_PATH: src/email_template.html
          OUTPUT_HTML: out/email.html
          SENDER_NAME: "Rajesh Dasari"
          DEFECT_SHEET_NAME: "NY_MECM_Performance_issues.xlsx"
        run: |
          mkdir -p out
          python src/build_email.py

      - name: Upload HTML as artifact
        uses: actions/upload-artifact@v4
        with:
          name: load-test-email
          path: out/email.html

      - name: Send email via SMTP
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_CC: ${{ secrets.EMAIL_CC }}
          EMAIL_SUBJECT: ${{ secrets.EMAIL_SUBJECT }}
        run: |
          python - <<'PYCODE'
# Code Generated by Sidekick is for learning and experimentation purposes only.
import os
from src.send_email import send_email_html

with open("out/email.html","r",encoding="utf-8") as f:
    html = f.read()

attachments = []
send_email_html(html, attachments=attachments)
PYCODE
